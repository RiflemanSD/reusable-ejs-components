<%- include('partials/header', { title: 'Μετατροπή CSV σε Excel' }) %>

<div style="min-height: 100vh; padding: 40px 0; background: #f5f7fa;">
  <div class="container" style="max-width: 600px; margin: 0 auto 30px auto;">
    <div class="header">
      <h1>📊 Μετατροπή CSV σε Excel</h1>
      <p>Ανεβάστε ένα αρχείο CSV και κατεβάστε το ως Excel (.xlsx)</p>
    </div>
    
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="success-message">
        ✅ Επιτυχής μετατροπή! Το αρχείο θα κατέβει αυτόματα.
      </div>
    <% } %>
    
    <% /* Using the File Upload Form Component */ %>
    <%- include('partials/components/file-upload-form', { 
      formId: 'uploadForm',
      action: '/csv-converter/upload',
      inputName: 'csvFile',
      inputId: 'csvFile',
      accept: '.csv',
      label: 'Επιλέξτε αρχείο CSV',
      buttonText: 'Προεπισκόπηση CSV',
      buttonIcon: '👁️',
      maxSize: '10MB'
    }) %>
    
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e8eef3;">
      <div class="button-group">
        <a href="/" class="btn btn-secondary">🏠 Αρχική</a>
        <form method="POST" action="/logout" style="flex: 1;">
          <button type="submit" class="btn btn-danger">🚪 Αποσύνδεση</button>
        </form>
      </div>
    </div>
  </div>

  <% if (typeof previewData !== 'undefined' && previewData && previewData.length > 0) { %>
    <div style="width: 98%; max-width: none; margin: 0 auto; padding: 25px; background: #f9f9fa; border-radius: 8px; border: 1px solid #e8eef3; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <h2 style="margin-top: 0; color: #2c3e50; font-size: 20px; margin-bottom: 20px;">
        📄 Προεπισκόπηση: <%= fileName %>
      </h2>
      
      <% /* Using Stats Cards Components */ %>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
        <%- include('partials/components/stats-card', { 
          icon: '📊', 
          label: 'Σύνολο Γραμμών', 
          value: previewData.length,
          color: '#f0f9ff',
          valueColor: '#0284c7'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '📋', 
          label: 'Αριθμός Στηλών', 
          value: previewData[0] ? previewData[0].length : 0,
          color: '#f0fdf4',
          valueColor: '#16a34a'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '📄', 
          label: 'Όνομα Αρχείου', 
          value: fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName,
          color: '#fef9f3',
          valueColor: '#ea580c'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '🔧', 
          label: 'Διαχωριστικό', 
          value: typeof detectedDelimiter !== 'undefined' ? (detectedDelimiter === ',' ? 'Κόμμα (,)' : detectedDelimiter === ';' ? 'Ερωτηματικό (;)' : detectedDelimiter === '\t' ? 'Tab' : detectedDelimiter) : 'Κόμμα (,)',
          color: '#fef3f2',
          valueColor: '#dc2626'
        }) %>
      </div>
      
      <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e8eef3; margin-bottom: 25px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 16px; margin-bottom: 15px;">
          ⚙️ Ρυθμίσεις Μετατροπής
        </h3>
        
        <form id="reloadForm" method="POST" action="/csv-converter/reload">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
              Διαχωριστικό Σύμβολο:
            </label>
            <select id="delimiter" name="delimiter" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
              <option value="," <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === ',') ? 'selected' : '' %>>Κόμμα (,)</option>
              <option value=";" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === ';') ? 'selected' : '' %>>Ερωτηματικό (;)</option>
              <option value="	" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === '\t') ? 'selected' : '' %>>Tab</option>
              <option value="|" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === '|') ? 'selected' : '' %>>Pipe (|)</option>
            </select>
            <small style="color: #6b7280; font-size: 12px;">
              ✅ Αυτόματα ανιχνεύτηκε: <strong><%= typeof detectedDelimiter !== 'undefined' ? (detectedDelimiter === ',' ? 'Κόμμα' : detectedDelimiter === ';' ? 'Ερωτηματικό' : detectedDelimiter === '\t' ? 'Tab' : detectedDelimiter) : 'Κόμμα' %></strong>
            </small>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
              Custom Διαχωριστικό (προαιρετικό):
            </label>
            <input 
              type="text" 
              id="customDelimiter" 
              name="customDelimiter" 
              maxlength="1"
              placeholder="π.χ. : ή ~"
              value="<%= typeof customDelimiter !== 'undefined' ? customDelimiter : '' %>"
              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <small style="color: #6b7280; font-size: 12px;">
              💡 Αν θέλεις άλλο σύμβολο, γράψε το εδώ (1 χαρακτήρας)
            </small>
          </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
          <button type="submit" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
            🔄 Επαναφόρτωση με νέες ρυθμίσεις
          </button>
        </div>
        </form>
        
        <% if (typeof columnTypes !== 'undefined' && columnTypes && columnTypes.length > 0) { %>
          <div style="margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">
              📋 Τύποι Στηλών (Αυτόματη Ανίχνευση):
            </h4>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; background: #f9fafb;">
              <table style="width: 100%; font-size: 13px;">
                <thead style="background: #f3f4f6; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Στήλη</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Ανιχνευμένος Τύπος</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Επιλογή Τύπου</th>
                  </tr>
                </thead>
                <tbody>
                  <% columnTypes.forEach((col, index) => { %>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 8px; font-weight: 500;"><%= col.name %></td>
                      <td style="padding: 8px;">
                        <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; 
                          background: <%= col.detectedType === 'string' ? '#dbeafe' : col.detectedType === 'integer' ? '#dcfce7' : col.detectedType === 'float' ? '#fef3c7' : '#e0e7ff' %>;
                          color: <%= col.detectedType === 'string' ? '#1e40af' : col.detectedType === 'integer' ? '#15803d' : col.detectedType === 'float' ? '#a16207' : '#4338ca' %>;">
                          <%= col.detectedType === 'string' ? '📝 String' : col.detectedType === 'integer' ? '🔢 Integer' : col.detectedType === 'float' ? '💯 Float' : '📅 Date' %>
                        </span>
                        <% if (col.hasEmpty) { %>
                          <span style="color: #9ca3af; font-size: 11px; margin-left: 5px;">⚠️ Έχει κενά</span>
                        <% } %>
                      </td>
                      <td style="padding: 8px;">
                        <select name="columnType_<%= index %>" style="width: 100%; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                          <option value="string" <%= col.detectedType === 'string' ? 'selected' : '' %>>String</option>
                          <option value="integer" <%= col.detectedType === 'integer' ? 'selected' : '' %>>Integer</option>
                          <option value="float" <%= col.detectedType === 'float' ? 'selected' : '' %>>Float</option>
                          <option value="date" <%= col.detectedType === 'date' ? 'selected' : '' %>>Date</option>
                        </select>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 8px;">
              💡 Οι τύποι ανιχνεύτηκαν αυτόματα. Μπορείς να τους αλλάξεις αν χρειάζεται.
            </small>
          </div>
        <% } %>
      </div>
      
      <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e8eef3; margin-bottom: 25px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 16px; margin-bottom: 15px;">
          ⬇️ Μετατροπή σε Excel
        </h3>
        
        <form id="convertForm" method="POST" action="/csv-converter/convert">
          <input type="hidden" name="delimiter" value="<%= typeof detectedDelimiter !== 'undefined' ? detectedDelimiter : ',' %>">
          <input type="hidden" name="customDelimiter" value="<%= typeof customDelimiter !== 'undefined' ? customDelimiter : '' %>">
          
          <div style="margin-bottom: 15px; text-align: center;">
            <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
              <input type="checkbox" name="autoWidth" value="true" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span>📏 Αυτόματο πλάτος στηλών (Auto-Width)</span>
            </label>
            <br>
            <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: inline-block;">
              💡 Προσαρμόζει το πλάτος κάθε στήλης στο περιεχόμενό της
            </small>
          </div>
          
          <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="display: inline-flex; align-items: center; gap: 8px; padding: 14px 28px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">
              📊 Μετατροπή και Λήψη Excel
            </button>
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; text-align: center; margin-top: 10px;">
            ✅ Το Excel θα έχει μορφοποίηση πίνακα με numbers, colors και borders
          </small>
        </form>
      </div>

      <% /* Using the Data Table Component */ %>
      <%- include('partials/components/data-table', { 
        data: previewData,
        maxHeight: '600px',
        showRowNumbers: false
      }) %>
    </div>
  <% } %>
</div>

<%- include('partials/footer') %>
