<%- include('partials/header', { title: 'Μετατροπή CSV σε Excel' }) %>

<style>
  /* Constrain header icons across this page */
  .hero-header svg { width: 2rem; height: 2rem; flex-shrink: 0; }
  .hero-header .text-3xl { line-height: 1.2; }
  @media (min-width: 768px) { .hero-header svg { width: 2rem; height: 2rem; } }
  @media (max-width: 767px) { .hero-header svg { width: 1.75rem; height: 1.75rem; } }
  
</style>

<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 py-8">
  <div class="container mx-auto px-4 max-w-2xl mb-8">
    <!-- Page Header -->
    <div class="card bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-2xl mb-6">
      <div class="card-body text-center hero-header">
        <div class="flex items-center justify-center gap-3 mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
          </svg>
          <h1 class="text-3xl font-bold">Μετατροπή CSV σε Excel</h1>
        </div>
        <p class="text-blue-100 text-base">Ανεβάστε ένα αρχείο CSV και κατεβάστε το ως Excel (.xlsx)</p>
      </div>
    </div>
    
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success shadow-lg mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Επιτυχής μετατροπή! Το αρχείο θα κατέβει αυτόματα.</span>
      </div>
    <% } %>
    
    <!-- File Upload Card -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <%- include('partials/components/file-upload-form', { 
          formId: 'uploadForm',
          action: '/csv-converter/upload',
          inputName: 'csvFile',
          inputId: 'csvFile',
          accept: '.csv',
          label: 'Επιλέξτε αρχείο CSV',
          buttonText: 'Προεπισκόπηση CSV',
          buttonIcon: '👁️',
          maxSize: '10MB'
        }) %>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="divider"></div>
    <div class="flex gap-4 flex-wrap">
      <a href="/" class="btn btn-outline gap-2 flex-1 sm:flex-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        Αρχική
      </a>
      <form method="POST" action="/logout" class="flex-1 sm:flex-none">
        <button type="submit" class="btn btn-error gap-2 w-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Αποσύνδεση
        </button>
      </form>
    </div>
  </div>

  <% if (typeof previewData !== 'undefined' && previewData && previewData.length > 0) { %>
    <div class="container mx-auto px-4 mb-8">
      <!-- File Info Header -->
      <div class="alert bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-xl mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <div>
          <h3 class="font-bold text-xl">Προεπισκόπηση Αρχείου</h3>
          <div class="text-sm text-blue-100"><%= fileName %></div>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <%- include('partials/components/stats-card', { 
          icon: '📊', 
          label: 'Σύνολο Γραμμών', 
          value: previewData.length,
          color: '#f0f9ff',
          valueColor: '#0284c7'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '📋', 
          label: 'Αριθμός Στηλών', 
          value: previewData[0] ? previewData[0].length : 0,
          color: '#f0fdf4',
          valueColor: '#16a34a'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '📄', 
          label: 'Όνομα Αρχείου', 
          value: fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName,
          color: '#fef9f3',
          valueColor: '#ea580c'
        }) %>
        
        <%- include('partials/components/stats-card', { 
          icon: '🔧', 
          label: 'Διαχωριστικό', 
          value: typeof detectedDelimiter !== 'undefined' ? (detectedDelimiter === ',' ? 'Κόμμα (,)' : detectedDelimiter === ';' ? 'Ερωτηματικό (;)' : detectedDelimiter === '\t' ? 'Tab' : detectedDelimiter) : 'Κόμμα (,)',
          color: '#fef3f2',
          valueColor: '#dc2626'
        }) %>
      </div>
      
      <!-- Settings Card -->
      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
          <h3 class="card-title text-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Ρυθμίσεις Μετατροπής
          </h3>
          
          <form id="reloadForm" method="POST" action="/csv-converter/reload">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-semibold">Διαχωριστικό Σύμβολο:</span>
                </label>
                <select id="delimiter" name="delimiter" class="select select-bordered w-full">
                  <option value="," <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === ',') ? 'selected' : '' %>>Κόμμα (,)</option>
                  <option value=";" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === ';') ? 'selected' : '' %>>Ερωτηματικό (;)</option>
                  <option value="	" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === '\t') ? 'selected' : '' %>>Tab</option>
                  <option value="|" <%= (typeof detectedDelimiter !== 'undefined' && detectedDelimiter === '|') ? 'selected' : '' %>>Pipe (|)</option>
                </select>
                <label class="label">
                  <span class="label-text-alt">✅ Αυτόματα ανιχνεύτηκε: <strong><%= typeof detectedDelimiter !== 'undefined' ? (detectedDelimiter === ',' ? 'Κόμμα' : detectedDelimiter === ';' ? 'Ερωτηματικό' : detectedDelimiter === '\t' ? 'Tab' : detectedDelimiter) : 'Κόμμα' %></strong></span>
                </label>
              </div>
              
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-semibold">Custom Διαχωριστικό (προαιρετικό):</span>
                </label>
                <input 
                  type="text" 
                  id="customDelimiter" 
                  name="customDelimiter" 
                  maxlength="1"
                  placeholder="π.χ. : ή ~"
                  value="<%= typeof customDelimiter !== 'undefined' ? customDelimiter : '' %>"
                  class="input input-bordered w-full">
                <label class="label">
                  <span class="label-text-alt">💡 Αν θέλεις άλλο σύμβολο, γράψε το εδώ (1 χαρακτήρας)</span>
                </label>
              </div>
            </div>
            
            <div class="text-center mb-4">
              <button type="submit" class="btn btn-primary gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Επαναφόρτωση με νέες ρυθμίσεις
              </button>
            </div>
          </form>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
              Custom Διαχωριστικό (προαιρετικό):
            </label>
            <input 
              type="text" 
              id="customDelimiter" 
              name="customDelimiter" 
              maxlength="1"
              placeholder="π.χ. : ή ~"
              value="<%= typeof customDelimiter !== 'undefined' ? customDelimiter : '' %>"
              style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
            <small style="color: #6b7280; font-size: 12px;">
              💡 Αν θέλεις άλλο σύμβολο, γράψε το εδώ (1 χαρακτήρας)
            </small>
          </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
          <button type="submit" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
            🔄 Επαναφόρτωση με νέες ρυθμίσεις
          </button>
        </div>
        </form>
        
        <% if (typeof columnTypes !== 'undefined' && columnTypes && columnTypes.length > 0) { %>
          <div style="margin-top: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px; display: flex; align-items: center; justify-content: space-between;">
              <span>📋 Τύποι Στηλών (Αυτόματη Ανίχνευση):</span>
              <button id="toggleColumnTypes" type="button" style="background: none; border: none; color: #2563eb; font-size: 13px; cursor: pointer; padding: 2px 8px; border-radius: 4px;">Απόκρυψη</button>
            </h4>
            <div id="columnTypesTableWrap" style="border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px; background: #f9fafb; transition: max-height 0.3s; max-height: none; overflow: hidden;">
              <table style="width: 100%; font-size: 13px;">
<script>
// Collapse/expand for column types
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('toggleColumnTypes');
  const wrap = document.getElementById('columnTypesTableWrap');
  let collapsed = false;
  if (btn && wrap) {
    btn.addEventListener('click', function() {
      collapsed = !collapsed;
      if (collapsed) {
        wrap.style.maxHeight = '0px';
        wrap.style.overflow = 'hidden';
        btn.textContent = 'Εμφάνιση';
      } else {
        wrap.style.maxHeight = 'none';
        wrap.style.overflow = 'visible';
        btn.textContent = 'Απόκρυψη';
      }
    });
  }
});
</script>
                <thead style="background: #f3f4f6; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Στήλη</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Ανιχνευμένος Τύπος</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #d1d5db;">Επιλογή Τύπου</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #d1d5db;">💰 Νόμισμα</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #d1d5db;">🔀 Μεικτά→String</th>
                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #d1d5db;">🔓 Unescape HTML</th>
                  </tr>
                </thead>
                <tbody>
                  <% columnTypes.forEach((col, index) => { %>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                      <td style="padding: 8px; font-weight: 500;"><%= col.name %></td>
                      <td style="padding: 8px;">
                        <span style="display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; 
                          background: <%= col.detectedType === 'string' ? '#dbeafe' : col.detectedType === 'integer' ? '#dcfce7' : col.detectedType === 'float' ? '#fef3c7' : '#e0e7ff' %>;
                          color: <%= col.detectedType === 'string' ? '#1e40af' : col.detectedType === 'integer' ? '#15803d' : col.detectedType === 'float' ? '#a16207' : '#4338ca' %>;">
                          <%= col.detectedType === 'string' ? '📝 String' : col.detectedType === 'integer' ? '🔢 Integer' : col.detectedType === 'float' ? '💯 Float' : '📅 Date' %>
                        </span>
                        <% if (col.isMixed) { %>
                          <span style="color: #f59e0b; font-size: 11px; margin-left: 5px; font-weight: 600;">⚠️ Mixed!</span>
                        <% } %>
                        <% if (col.hasEmpty) { %>
                          <span style="color: #9ca3af; font-size: 11px; margin-left: 5px;">⚠️ Κενά</span>
                        <% } %>
                      </td>
                      <td style="padding: 8px;">
                        <select name="columnType_<%= index %>" style="width: 100%; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                          <option value="string" <%= col.detectedType === 'string' ? 'selected' : '' %>>String</option>
                          <option value="integer" <%= col.detectedType === 'integer' ? 'selected' : '' %>>Integer</option>
                          <option value="float" <%= col.detectedType === 'float' ? 'selected' : '' %>>Float</option>
                          <option value="date" <%= col.detectedType === 'date' ? 'selected' : '' %>>Date</option>
                        </select>
                      </td>
                      <td style="padding: 8px; text-align: center;">
                        <input type="checkbox" name="currencyColumn_<%= index %>" value="true" style="width: 18px; height: 18px; cursor: pointer;" 
                          <%= (col.detectedType === 'float' || col.detectedType === 'integer') ? '' : 'disabled' %>>
                      </td>
                      <td style="padding: 8px; text-align: center;">
                        <input type="checkbox" name="mixedToString_<%= index %>" value="true" style="width: 18px; height: 18px; cursor: pointer;" 
                          <%= col.isMixed ? '' : 'disabled' %>>
                      </td>
                      <td style="padding: 8px; text-align: center;">
                        <input type="checkbox" name="unescapeHtml_<%= index %>" value="true" style="width: 18px; height: 18px; cursor: pointer;" 
                          <%= col.detectedType === 'string' ? '' : 'disabled' %>>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
            <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 8px;">
              💡 Οι τύποι ανιχνεύτηκαν αυτόματα. Μπορείς να τους αλλάξεις αν χρειάζεται.
            </small>
          </div>
        <% } %>
      </div>
      
      <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e8eef3; margin-bottom: 25px;">
        <h3 style="margin-top: 0; color: #2c3e50; font-size: 16px; margin-bottom: 15px;">
          ⬇️ Μετατροπή σε Excel
        </h3>
        
        <form id="convertForm" method="POST" action="/csv-converter/convert">
          <input type="hidden" name="delimiter" value="<%= typeof detectedDelimiter !== 'undefined' ? detectedDelimiter : ',' %>">
          <input type="hidden" name="customDelimiter" value="<%= typeof customDelimiter !== 'undefined' ? customDelimiter : '' %>">
          
          <div style="margin-bottom: 15px; text-align: center;">
            <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: #374151;">
              <input type="checkbox" name="autoWidth" value="true" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span>📏 Αυτόματο πλάτος στηλών (Auto-Width)</span>
            </label>
            <br>
            <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: inline-block;">
              💡 Προσαρμόζει το πλάτος κάθε στήλης στο περιεχόμενό της
            </small>
          </div>
          
          <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="display: inline-flex; align-items: center; gap: 8px; padding: 14px 28px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.2s;">
              📊 Μετατροπή και Λήψη Excel
            </button>
          </div>
          
          <small style="color: #6b7280; font-size: 12px; display: block; text-align: center; margin-top: 10px;">
            ✅ Το Excel θα έχει μορφοποίηση πίνακα με numbers, colors και borders
          </small>
        </form>
      </div>

      <% /* Using the Data Table Component */ %>
      <%- include('partials/components/data-table', { 
        data: previewData,
        maxHeight: '600px',
        showRowNumbers: false
      }) %>
    </div>
  <% } %>
</div>

<script>
// Enable/disable currency checkbox based on column type selection
document.addEventListener('DOMContentLoaded', function() {
  const typeSelects = document.querySelectorAll('[name^="columnType_"]');
  const convertForm = document.getElementById('convertForm');
  
  // Handle column type changes
  typeSelects.forEach((select, index) => {
    select.addEventListener('change', function() {
      const currencyCheckbox = document.querySelector(`[name="currencyColumn_${index}"]`);
      if (currencyCheckbox) {
        const selectedType = this.value;
        if (selectedType === 'float' || selectedType === 'integer') {
          currencyCheckbox.disabled = false;
        } else {
          currencyCheckbox.disabled = true;
          currencyCheckbox.checked = false;
        }
      }
    });
  });
  
  // Clone column types and currency columns to convert form on submit
  if (convertForm) {
    convertForm.addEventListener('submit', function(e) {
      // Remove old cloned inputs first
      convertForm.querySelectorAll('.cloned-column-data').forEach(el => el.remove());
      
      // Clone column type selects
      typeSelects.forEach((select, index) => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `columnType_${index}`;
        hiddenInput.value = select.value;
        hiddenInput.className = 'cloned-column-data';
        convertForm.appendChild(hiddenInput);
      });
      
      // Clone currency checkboxes
      const currencyCheckboxes = document.querySelectorAll('[name^="currencyColumn_"]');
      currencyCheckboxes.forEach((checkbox, index) => {
        if (checkbox.checked && !checkbox.disabled) {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = `currencyColumn_${index}`;
          hiddenInput.value = 'true';
          hiddenInput.className = 'cloned-column-data';
          convertForm.appendChild(hiddenInput);
        }
      });
      
      // Clone mixed-to-string checkboxes
      const mixedCheckboxes = document.querySelectorAll('[name^="mixedToString_"]');
      mixedCheckboxes.forEach((checkbox, index) => {
        if (checkbox.checked && !checkbox.disabled) {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = `mixedToString_${index}`;
          hiddenInput.value = 'true';
          hiddenInput.className = 'cloned-column-data';
          convertForm.appendChild(hiddenInput);
        }
      });
      
      // Clone unescape HTML checkboxes
      const unescapeCheckboxes = document.querySelectorAll('[name^="unescapeHtml_"]');
      unescapeCheckboxes.forEach((checkbox, index) => {
        if (checkbox.checked && !checkbox.disabled) {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = `unescapeHtml_${index}`;
          hiddenInput.value = 'true';
          hiddenInput.className = 'cloned-column-data';
          convertForm.appendChild(hiddenInput);
        }
      });
    });
  }

  // Auto-submit when file is selected
  const fileInput = document.getElementById('csvFile');
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      if (this.files && this.files.length > 0) {
        // Show loading state on button
        if (typeof toggleLoadingButton !== 'undefined') {
          toggleLoadingButton('uploadForm_submit', true);
        }
        
        // Submit the form automatically
        const form = document.getElementById('uploadForm');
        if (form) {
          form.submit();
        }
      }
    });
  }
});
</script>

<%- include('partials/footer') %>
